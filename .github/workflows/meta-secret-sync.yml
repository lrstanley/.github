name: meta-secret-sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: filter-repositories
        uses: actions/github-script@v6
        with:
          script: |
            const query = `
              query {
                viewer {
                  repositories(first: 100, isFork: false, isLocked: false, ownerAffiliations: [OWNER]) {
                    nodes {
                      isArchived
                      isDisabled
                      isMirror
                      isTemplate
                      isUserConfigurationRepository
                      nameWithOwner
                    }
                    pageInfo {
                      endCursor
                      hasNextPage
                    }
                  }
                }
              }
            `;
            const result = await github.graphql(query)
            console.log(result.viewer.repositories.nodes)
            core.setOutput("results", result)
      - uses: google/secrets-sync-action@v1.7.0
        with:
          SECRETS: |
            ^USER_PAT$
            ^SNYK.*
          REPOSITORIES: |
            ${{github.repository}}
          DRY_RUN: true
          GITHUB_TOKEN: ${{ secrets.SECRET_SYNC_PAT }}
